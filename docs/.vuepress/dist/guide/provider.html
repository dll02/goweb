<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.67">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>服务提供者 | 你好， VuePress ！</title><meta name="description" content="这是我的第一个 VuePress 站点">
    <link rel="preload" href="/assets/style-8a38cc2d.css" as="style"><link rel="stylesheet" href="/assets/style-8a38cc2d.css">
    <link rel="modulepreload" href="/assets/app-2d690129.js"><link rel="modulepreload" href="/assets/provider.html-f15f1118.js"><link rel="modulepreload" href="/assets/provider.html-ac117925.js"><link rel="prefetch" href="/assets/index.html-813e2324.js" as="script"><link rel="prefetch" href="/assets/index.html-b8705e31.js" as="script"><link rel="prefetch" href="/assets/app.html-98a70b2f.js" as="script"><link rel="prefetch" href="/assets/build.html-fcb80032.js" as="script"><link rel="prefetch" href="/assets/command.html-efbc4902.js" as="script"><link rel="prefetch" href="/assets/cron.html-1f508088.js" as="script"><link rel="prefetch" href="/assets/dev.html-bb0d6a16.js" as="script"><link rel="prefetch" href="/assets/env.html-0e0ef342.js" as="script"><link rel="prefetch" href="/assets/install.html-742d4a11.js" as="script"><link rel="prefetch" href="/assets/introduce.html-ca34760d.js" as="script"><link rel="prefetch" href="/assets/middleware.html-6d89c171.js" as="script"><link rel="prefetch" href="/assets/structure.html-4f327701.js" as="script"><link rel="prefetch" href="/assets/swagger.html-d25088ba.js" as="script"><link rel="prefetch" href="/assets/todo.html-77b4b180.js" as="script"><link rel="prefetch" href="/assets/index.html-6094e511.js" as="script"><link rel="prefetch" href="/assets/app.html-a30f63fd.js" as="script"><link rel="prefetch" href="/assets/config.html-5a980696.js" as="script"><link rel="prefetch" href="/assets/env.html-c661f759.js" as="script"><link rel="prefetch" href="/assets/log.html-6e07dd2d.js" as="script"><link rel="prefetch" href="/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/assets/index.html-77a28d93.js" as="script"><link rel="prefetch" href="/assets/index.html-6985c8c7.js" as="script"><link rel="prefetch" href="/assets/app.html-2c4c5072.js" as="script"><link rel="prefetch" href="/assets/build.html-e4a6adb4.js" as="script"><link rel="prefetch" href="/assets/command.html-5939ca7c.js" as="script"><link rel="prefetch" href="/assets/cron.html-a76540a8.js" as="script"><link rel="prefetch" href="/assets/dev.html-c51ba593.js" as="script"><link rel="prefetch" href="/assets/env.html-c988744d.js" as="script"><link rel="prefetch" href="/assets/install.html-37d9da85.js" as="script"><link rel="prefetch" href="/assets/introduce.html-4d0bc677.js" as="script"><link rel="prefetch" href="/assets/middleware.html-99d60fe1.js" as="script"><link rel="prefetch" href="/assets/structure.html-edeef759.js" as="script"><link rel="prefetch" href="/assets/swagger.html-c623f9f3.js" as="script"><link rel="prefetch" href="/assets/todo.html-c8d483fc.js" as="script"><link rel="prefetch" href="/assets/index.html-c38e9e1d.js" as="script"><link rel="prefetch" href="/assets/app.html-595e403e.js" as="script"><link rel="prefetch" href="/assets/config.html-731ff78d.js" as="script"><link rel="prefetch" href="/assets/env.html-ebda3614.js" as="script"><link rel="prefetch" href="/assets/log.html-621fd854.js" as="script"><link rel="prefetch" href="/assets/404.html-b01cc44d.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">你好， VuePress ！</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">服务提供者 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/guide/provider.html#指南" class="router-link-active router-link-exact-active sidebar-item" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/guide/provider.html#创建" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建"><!--[--><!--]--> 创建 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/guide/provider.html#自定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="自定义"><!--[--><!--]--> 自定义 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/guide/provider.html#contract-go" class="router-link-active router-link-exact-active sidebar-item" aria-label="contract.go"><!--[--><!--]--> contract.go <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/guide/provider.html#provider" class="router-link-active router-link-exact-active sidebar-item" aria-label="provider"><!--[--><!--]--> provider <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/guide/provider.html#service-go" class="router-link-active router-link-exact-active sidebar-item" aria-label="service.go"><!--[--><!--]--> service.go <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/guide/provider.html#注入" class="router-link-active router-link-exact-active sidebar-item" aria-label="注入"><!--[--><!--]--> 注入 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/guide/provider.html#获取" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取"><!--[--><!--]--> 获取 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/guide/provider.html#webgo-provider" class="router-link-active router-link-exact-active sidebar-item" aria-label="webgo provider"><!--[--><!--]--> webgo provider <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="服务提供者" tabindex="-1"><a class="header-anchor" href="#服务提供者" aria-hidden="true">#</a> 服务提供者</h1><h2 id="指南" tabindex="-1"><a class="header-anchor" href="#指南" aria-hidden="true">#</a> 指南</h2><p>webgo框架使用ServiceProvider机制来满足协议，通过service Provder提供某个协议服务的具体实现。这样如果开发者对具体的实现协议的服务类的具体实现不满意，则可以很方便的通过切换具体协议的Service Provider来进行具体服务的切换。</p><p>一个ServiceProvider是一个单独的文件夹，它包含服务提供和服务实现。具体可以参考framework/provider/demo</p><p>一个SerivceProvider就是一个独立的包，这个包可以作为插件独立地发布和分享。</p><p>你也可以定义一个无contract的ServiceProvider，其中的Name()需要保证唯一。</p><h2 id="创建" tabindex="-1"><a class="header-anchor" href="#创建" aria-hidden="true">#</a> 创建</h2><p>我们可以使用命令 <code>./webgo provider new</code> 来创建一个新的service provider</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[~/Documents/workspace/webgo_workspace/demo5]$ ./webgo provider new
create a provider
? please input provider name test
? please input provider folder(default: provider name):
create provider success, folder path: /Users/Documents/workspace/webgo_workspace/demo5/app/provider/test
please remember add provider to kernel
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该命令会在<code>app/provider/</code> 目录下创建一个对应的服务提供者。并且初始化好三个文件： <code>contract.go</code>, <code>provider.go</code>, <code>service.go</code></p><h2 id="自定义" tabindex="-1"><a class="header-anchor" href="#自定义" aria-hidden="true">#</a> 自定义</h2><p>我们需要编写这三个文件：</p><h3 id="contract-go" tabindex="-1"><a class="header-anchor" href="#contract-go" aria-hidden="true">#</a> contract.go</h3><p>contract.go 定义了这个服务提供方提供的协议接口。webgo 框架任务，作为一个业务的服务提供者，定义一个好的协议是最重要的事情。</p><p>所以 contract.go 中定义了一个 Service 接口，在其中定义各种方法，包含输入参数和返回参数。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>package demo

const DemoKey = &quot;demo&quot;

type IService interface {
	GetAllStudent() []Student
}

type Student struct {
	ID   int
	Name string
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中还定义了一个Key， 这个 Key 是全应用唯一的，服务提供者将服务以 Key 关键字注入到容器中。服务使用者使用 Key 关键字获取服务。</p><h3 id="provider" tabindex="-1"><a class="header-anchor" href="#provider" aria-hidden="true">#</a> provider</h3><p>provider.go 提供服务适配的实现，实现一个Provider必须实现对应的五个方法</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>package demo

import (
	&quot;github.com/dll02/webgo/framework&quot;
)

type DemoProvider struct {
	framework.ServiceProvider

	c framework.Container
}

func (sp *DemoProvider) Name() string {
	return DemoKey
}

func (sp *DemoProvider) Register(c framework.Container) framework.NewInstance {
	return NewService
}

func (sp *DemoProvider) IsDefer() bool {
	return false
}

func (sp *DemoProvider) Params() []interface{} {
	return []interface{}{sp.c}
}

func (sp *DemoProvider) Boot(c framework.Container) error {
	sp.c = c
	return nil
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Name() // 指定这个服务提供者提供的服务对应的接口的关键字</li><li>Register() // 这个服务提供者注册的时候调用的方法，一般是指定初始化服务的函数名</li><li>IsDefer() // 这个服务是否是使用时候再进行初始化，false为注册的时候直接进行初始化服务</li><li>Params() // 初始化服务的时候对服务注入什么参数，一般把 container 注入到服务中</li><li>Boot() // 初始化之前调用的函数，一般设置一些全局的Provider</li></ul><h3 id="service-go" tabindex="-1"><a class="header-anchor" href="#service-go" aria-hidden="true">#</a> service.go</h3><p>service.go提供具体的实现，它至少需要提供一个实例化的方法 <code>NewService(params ...interface{}) (interface{}, error)</code>。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>package demo

import &quot;github.com/dll02/webgo/framework&quot;

type Service struct {
	container framework.Container
}

func NewService(params ...interface{}) (interface{}, error) {
	container := params[0].(framework.Container)
	return &amp;Service{container: container}, nil
}

func (s *Service) GetAllStudent() []Student {
	return []Student{
		{
			ID:   1,
			Name: &quot;foo&quot;,
		},
		{
			ID:   2,
			Name: &quot;bar&quot;,
		},
	}
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="注入" tabindex="-1"><a class="header-anchor" href="#注入" aria-hidden="true">#</a> 注入</h2><p>webgo的路由，controller的定义是选择基于gin框架进行扩展的。所有的gin框架的路由，参数获取，验证，context都和gin框架是相同的。唯一不同的是gin的全局路由gin.Engine实现了webgo的容器结构，可以对gin.Engine进行服务提供的注入，且可以从context中获取具体的服务。</p><p>webgo提供两种服务注入的方法：</p><ul><li>Bind: 将一个ServiceProvider绑定到容器中，可以控制其是否是单例</li><li>Singleton: 将一个单例ServiceProvider绑定到容器中</li></ul><p>建议在文件夹 <code>app/provider/kernel.go</code> 中进行服务注入</p><div class="language-golang line-numbers-mode" data-ext="golang"><pre class="language-golang"><code>func RegisterCustomProvider(c framework.Container) {
	c.Bind(&amp;demo.DemoProvider{}, true)
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然你也可以在某个业务模块路由注册的时候进行服务注入</p><div class="language-golang line-numbers-mode" data-ext="golang"><pre class="language-golang"><code>func Register(r *gin.Engine) error {
	api := NewDemoApi()
	r.Container().Singleton(&amp;demoService.DemoProvider{})

	r.GET(&quot;/demo/demo&quot;, api.Demo)
	r.GET(&quot;/demo/demo2&quot;, api.Demo2)
	return nil
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="获取" tabindex="-1"><a class="header-anchor" href="#获取" aria-hidden="true">#</a> 获取</h2><p>webgo提供了三种服务获取的方法：</p><ul><li>Make: 根据一个Key获取服务，获取不到获取报错</li><li>MustMake: 根据一个Key获取服务，获取不到返回空</li><li>MakeNew: 根据一个Key获取服务，每次获取都实例化，对应的ServiceProvider必须是以非单例形式注入</li></ul><p>你可以在任意一个可以获取到 container 的地方进行服务的获取。</p><p>业务模块中:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>func (api *DemoApi) Demo2(c *gin.Context) {
	demoProvider := c.MustMake(demoService.DemoKey).(demoService.IService)
	students := demoProvider.GetAllStudent()
	usersDTO := StudentsToUserDTOs(students)
	c.JSON(200, usersDTO)
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>命令行中：</p><div class="language-golang line-numbers-mode" data-ext="golang"><pre class="language-golang"><code>var CenterCommand = &amp;cobra.Command{
	Use:   &quot;direct_center&quot;,
	Short: &quot;计算区域中心点&quot;,
	RunE: func(c *cobra.Command, args []string) error {
		container := util.GetContainer(c.Root())
		app := container.MustMake(contract.AppKey).(contract.App)
        return nil
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>甚至于另外一个服务提供者中：</p><div class="language-golang line-numbers-mode" data-ext="golang"><pre class="language-golang"><code>type Service struct {
	c framework.Container

	baseURL string
	userID  string
	token   string
	logger  contract.Log
}

func NewService(params ...interface{}) (interface{}, error) {
	c := params[0].(framework.Container)
	config := c.MustMake(contract.ConfigKey).(contract.Config)
	baseURL := config.GetString(&quot;app.stsmap.url&quot;)
	userID := config.GetString(&quot;app.stsmap.user_id&quot;)
	token := config.GetString(&quot;app.stsmap.token&quot;)

	logger := c.MustMake(contract.LogKey).(contract.Log)
	return &amp;Service{baseURL: baseURL, logger: logger, userID: userID, token: token}, nil
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="webgo-provider" tabindex="-1"><a class="header-anchor" href="#webgo-provider" aria-hidden="true">#</a> webgo provider</h2><p>webgo 框架默认自带了一些服务提供者，提供基础的服务接口协议，可以通过 <code>./webgo provider list</code> 来获取已经安装的服务提供者。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[~/Documents/workspace/webgo_workspace/demo5]$ ./webgo provider list
webgo:app
webgo:env
webgo:config
webgo:log
webgo:ssh
webgo:kernel
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>webgo 框架自带的服务提供者的 key 是以 <code>webgo:</code> 开头。目的为的是与自定义服务提供者的 key 区别开。</p><p>webgo 框架自带的服务提供者具体定义的协议可以参考：<a href="/provider/" class="">provider</a></p></div><!--[--><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app-2d690129.js" defer></script>
  </body>
</html>
